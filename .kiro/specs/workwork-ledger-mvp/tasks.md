# 实现计划

## 阶段 P0: 项目基础与认证

- [x] 1. 项目初始化与基础架构
  - [x] 1.1 创建 Next.js 14 项目，配置 TypeScript、ESLint、Prettier
    - 使用 App Router
    - 配置路径别名 @/
    - _需求: 基础架构_
  - [x] 1.2 配置 Prisma ORM 和 PostgreSQL 连接
    - 创建 prisma/schema.prisma
    - 配置数据库连接环境变量
    - _需求: 10.1_
  - [x] 1.3 配置 tRPC 和 React Query
    - 设置 tRPC router
    - 配置 React Query provider
    - _需求: 基础架构_
  - [x] 1.4 配置 Vitest 和 fast-check 测试框架
    - 创建 vitest.config.ts
    - 配置 fast-check 默认参数（100 次迭代）
    - _需求: 测试策略_
  - [x] 1.5 编写基础测试工具和生成器
    - 创建 currencyArb、moneyArb 等自定义生成器
    - _需求: 测试策略_

- [x] 2. 数据模型定义
  - [x] 2.1 定义 User、UserSettings、TrustedDevice、TwoFactorAuth 模型
    - 创建 Prisma schema
    - 生成迁移文件
    - _需求: 1.1-1.10_
  - [x] 2.2 定义 Client、Project 模型
    - 包含软删除字段 (active, archived)
    - _需求: 3.1-3.5, 4.1-4.4_
  - [x] 2.3 定义 Invoice、LineItem、Payment 模型
    - 包含状态枚举、支付方式枚举
    - _需求: 5.1-5.10_
  - [x] 2.4 定义 LedgerEntry、WalletAddress 模型
    - 包含链和资产枚举
    - _需求: 7.1-7.4, 8.1-8.4_
  - [x] 2.5 编写属性测试：发票序列化 Round-Trip
    - **属性 25: 发票序列化 Round-Trip**
    - **验证: 需求 10.1, 10.2**
  - [x] 2.6 编写属性测试：账本条目序列化 Round-Trip
    - **属性 26: 账本条目序列化 Round-Trip**
    - **验证: 需求 10.3, 10.4**
  - [x] 2.7 编写属性测试：货币金额精度保持
    - **属性 27: 货币金额精度保持**
    - **验证: 需求 10.5**

- [ ] 3. 认证模块实现
  - [x] 3.1 实现 Magic Link 发送功能
    - 集成 Resend 邮件服务
    - 生成安全 token 并存储到 Redis（15 分钟过期）
    - _需求: 1.1_
  - [x] 3.2 实现 Magic Link 验证和会话创建
    - 验证 token 有效性和过期时间
    - 创建 NextAuth session
    - _需求: 1.2, 1.10_
  - [x] 3.3 编写属性测试：Magic Link 过期验证
    - **属性 1: Magic Link 过期验证**
    - **验证: 需求 1.10**
  - [x] 3.4 实现设备指纹记录和检测
    - 收集浏览器指纹（userAgent、platform、timezone、language）
    - 存储到 TrustedDevice 表
    - _需求: 1.2, 1.3, 1.4_
  - [x] 3.5 编写属性测试：设备信任检测一致性
    - **属性 2: 设备信任检测一致性**
    - **验证: 需求 1.3, 1.4**
  - [x] 3.6 实现 2FA (TOTP) 功能
    - 生成 secret 和 QR code
    - 验证 TOTP code
    - _需求: 1.5, 1.6_
  - [x] 3.7 编写属性测试：TOTP 验证正确性
    - **属性 3: TOTP 验证正确性**
    - **验证: 需求 1.5**
  - [x] 3.8 实现用户设置 CRUD
    - businessName、logoUrl、country、defaultCurrency
    - _需求: 1.8, 1.9_

- [x] 4. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 阶段 P1: 核心业务功能

- [x] 5. 客户管理模块
  - [x] 5.1 实现客户 CRUD API
    - 创建、读取、更新、软删除
    - _需求: 3.1, 3.3, 3.4_
  - [x] 5.2 实现客户搜索功能
    - 按名称和邮箱模糊搜索
    - _需求: 3.5_
  - [x] 5.3 编写属性测试：客户搜索正确性
    - 搜索结果应包含匹配项
    - _需求: 3.5_
  - [x] 5.4 实现客户管理前端页面
    - 列表、创建、编辑表单
    - _需求: 3.2_

- [x] 6. 项目管理模块
  - [x] 6.1 实现项目 CRUD API
    - 创建、读取、归档
    - _需求: 4.1, 4.4_
  - [x] 6.2 实现项目管理前端页面
    - 列表、创建表单
    - _需求: 4.2_

- [x] 7. 发票核心功能
  - [x] 7.1 实现发票计算逻辑
    - 明细项 total = quantity × unitPrice
    - subtotal = sum(lineItems.total)
    - taxAmount = subtotal × taxRate
    - total = subtotal + taxAmount
    - _需求: 5.1, 5.2, 5.3_
  - [x] 7.2 编写属性测试：明细项金额计算
    - **属性 4: 明细项金额计算**
    - **验证: 需求 5.2**
  - [x] 7.3 编写属性测试：发票小计计算
    - **属性 5: 发票小计计算**
    - **验证: 需求 5.1**
  - [x] 7.4 编写属性测试：发票税额计算
    - **属性 6: 发票税额计算**
    - **验证: 需求 5.3**
  - [x] 7.5 编写属性测试：发票总额计算
    - **属性 7: 发票总额计算**
    - **验证: 需求 5.1, 5.3**
  - [x] 7.6 实现发票创建 API
    - 生成唯一发票编号
    - 初始状态为 draft
    - _需求: 5.4_
  - [x] 7.7 编写属性测试：发票编号唯一性
    - **属性 8: 发票编号唯一性**
    - **验证: 需求 5.4**
  - [x] 7.8 编写属性测试：发票初始状态
    - **属性 9: 发票初始状态**
    - **验证: 需求 5.4**
  - [x] 7.9 实现发票状态转换逻辑
    - draft → sent（生成 paymentToken）
    - sent → paid / overdue / cancelled
    - _需求: 5.5, 5.7, 5.8, 5.9_
  - [x] 7.10 编写属性测试：发票发送状态转换
    - **属性 10: 发票发送状态转换**
    - **验证: 需求 5.5**
  - [x] 7.11 编写属性测试：发票逾期状态转换
    - **属性 11: 发票逾期状态转换**
    - **验证: 需求 5.8**
  - [x] 7.12 编写属性测试：发票取消状态转换
    - **属性 12: 发票取消状态转换**
    - **验证: 需求 5.9**
  - [x] 7.13 实现发票列表和筛选 API
    - 按状态、客户、项目、日期范围筛选
    - _需求: 5.10_
  - [x] 7.14 编写属性测试：发票筛选正确性
    - **属性 18: 账本筛选正确性**（复用筛选逻辑）
    - **验证: 需求 5.10**
  - [x] 7.15 实现发票 PDF 导出
    - 使用 @react-pdf/renderer 或 puppeteer
    - _需求: 5.6_

- [x] 8. 发票前端页面
  - [x] 8.1 实现发票列表页面
    - 状态筛选、搜索、分页
    - _需求: 5.10_
  - [x] 8.2 实现发票创建/编辑页面
    - 客户选择、明细项动态添加、实时计算
    - _需求: 5.1-5.4_
  - [x] 8.3 实现发票详情页面
    - 状态操作按钮（发送、标记已付、取消）
    - PDF 下载
    - _需求: 5.5-5.9_

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 阶段 P2: 支付集成

- [x] 10. 支付网关抽象层
  - [x] 10.1 定义 PaymentGateway 接口
    - createCheckoutSession、verifyWebhook、getPaymentStatus
    - _需求: 6.2, 6.4_
  - [x] 10.2 实现 Stripe 适配器
    - 创建 Checkout Session
    - 处理 Webhook 签名验证
    - _需求: 2.2, 6.2, 6.4_
  - [x] 10.3 实现 PSP 凭证验证和存储
    - 加密存储 API keys
    - _需求: 2.2, 2.5_

- [x] 11. 客户支付页面
  - [x] 11.1 实现公开支付页面路由
    - /pay/[token] 路由
    - 验证 token 有效性
    - _需求: 6.1, 6.6_
  - [x] 11.2 编写属性测试：支付链接有效性
    - **属性 15: 支付链接有效性**
    - **验证: 需求 6.1**
  - [x] 11.3 实现支付页面 UI
    - 显示发票详情
    - 支付方式选择
    - _需求: 6.1, 6.2, 6.3_
  - [x] 11.4 实现 PSP Checkout 跳转
    - 创建 Checkout Session 并重定向
    - _需求: 6.2_

- [ ] 12. Webhook 处理
  - [ ] 12.1 实现 Stripe Webhook 端点
    - 签名验证
    - 幂等性处理（记录已处理的 eventId）
    - _需求: 6.4_
  - [ ] 12.2 实现支付成功处理逻辑
    - 更新发票状态为 paid
    - 创建账本条目
    - _需求: 6.4, 5.7_
  - [ ] 12.3 编写属性测试：支付完成创建账本条目
    - **属性 13: 支付完成创建账本条目**
    - **验证: 需求 5.7, 8.1**
  - [ ] 12.4 实现支付失败处理逻辑
    - 记录错误日志
    - 保持发票状态不变
    - _需求: 6.7_
  - [ ] 12.5 编写属性测试：支付验证失败状态不变
    - **属性 14: 支付验证失败状态不变**
    - **验证: 需求 6.7**

- [ ] 13. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 阶段 P3: 多链稳定币收款

- [ ] 14. 链抽象层实现
  - [ ] 14.1 定义 ChainAbstractionLayer 接口
    - generateAddress、subscribeToAddress、verifyTransaction
    - _需求: 7.1, 7.4_
  - [ ] 14.2 集成 Alchemy SDK
    - 配置多链支持（Arbitrum、Base、Polygon）
    - _需求: 7.1_
  - [ ] 14.3 实现收款地址生成
    - 为每条链生成独立地址
    - 存储到 WalletAddress 表
    - _需求: 2.4, 7.1_
  - [ ] 14.4 编写属性测试：多链地址独立性
    - **属性 16: 多链地址独立性**
    - **验证: 需求 7.1**

- [ ] 15. 稳定币支付流程
  - [ ] 15.1 实现稳定币支付选项 UI
    - 链选择、地址显示、QR 码生成
    - _需求: 6.3_
  - [ ] 15.2 配置 Alchemy Webhooks
    - 监听 USDC/USDT 转账事件
    - _需求: 6.5_
  - [ ] 15.3 实现链上交易验证
    - 验证金额、确认数
    - _需求: 6.5, 7.4_
  - [ ] 15.4 实现稳定币支付成功处理
    - 更新发票状态
    - 创建包含链信息的账本条目
    - _需求: 6.5, 7.2_

- [ ] 16. 稳定币收款设置
  - [ ] 16.1 实现稳定币设置 UI
    - 资产选择（USDC/USDT）
    - 链选择（Arbitrum/Base/Polygon）
    - _需求: 2.3_
  - [ ] 16.2 实现设置保存和地址生成
    - 保存配置后自动生成地址
    - _需求: 2.4_

- [ ] 17. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 阶段 P4: 账本与仪表盘

- [ ] 18. 账本模块
  - [ ] 18.1 实现账本条目自动创建
    - 支付成功时自动创建
    - 包含所有必要字段
    - _需求: 8.1_
  - [ ] 18.2 实现账本列表和筛选 API
    - 时间范围、客户、项目、币种、支付方式筛选
    - _需求: 8.2_
  - [ ] 18.3 编写属性测试：账本筛选正确性
    - **属性 18: 账本筛选正确性**
    - **验证: 需求 8.2**
  - [ ] 18.4 实现汇率转换
    - 获取汇率（可先用固定汇率，后续接入 API）
    - 计算 amountInDefaultCurrency
    - _需求: 8.4_
  - [ ] 18.5 编写属性测试：汇率转换正确性
    - **属性 19: 汇率转换正确性**
    - **验证: 需求 8.4**
  - [ ] 18.6 实现 CSV 导出
    - 导出筛选后的账本条目
    - _需求: 8.3_
  - [ ] 18.7 实现账本前端页面
    - 列表、筛选、导出按钮
    - _需求: 8.2, 8.3_

- [ ] 19. 仪表盘模块
  - [ ] 19.1 实现仪表盘统计 API
    - 总收入、按时间段聚合
    - _需求: 9.1, 9.2_
  - [ ] 19.2 编写属性测试：仪表盘总收入计算
    - **属性 20: 仪表盘总收入计算**
    - **验证: 需求 9.1**
  - [ ] 19.3 实现收入趋势聚合
    - 按周/月聚合
    - _需求: 9.3_
  - [ ] 19.4 编写属性测试：时间聚合守恒
    - **属性 21: 时间聚合守恒**
    - **验证: 需求 9.3**
  - [ ] 19.5 实现客户排名统计
    - Top 5 客户及百分比
    - _需求: 9.4_
  - [ ] 19.6 编写属性测试：客户排名正确性
    - **属性 22: 客户排名正确性**
    - **验证: 需求 9.4**
  - [ ] 19.7 实现支付方式分布统计
    - 法币 vs 稳定币比例
    - _需求: 9.5_
  - [ ] 19.8 编写属性测试：支付方式分布守恒
    - **属性 23: 支付方式分布守恒**
    - **验证: 需求 9.5**
  - [ ] 19.9 实现预留税金计算
    - totalIncome × taxRate
    - _需求: 9.6_
  - [ ] 19.10 编写属性测试：预留税金计算
    - **属性 24: 预留税金计算**
    - **验证: 需求 9.6**
  - [ ] 19.11 实现仪表盘前端页面
    - 时间选择器、统计卡片、图表
    - _需求: 9.1-9.6_

- [ ] 20. 稳定币收入聚合
  - [ ] 20.1 实现按资产和链的收入聚合
    - 统一总额 + 链明细
    - _需求: 7.3_
  - [ ] 20.2 编写属性测试：稳定币收入聚合一致性
    - **属性 17: 稳定币收入聚合一致性**
    - **验证: 需求 7.3**

- [ ] 21. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

