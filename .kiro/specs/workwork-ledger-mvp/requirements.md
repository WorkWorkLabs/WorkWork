# 需求文档

## 简介

WorkWork Ledger 是一款面向数字游民、自由职业者、一人公司和小型远程工作室的轻量级收入管理工具。MVP 聚焦"收入侧"，让用户能在 30 秒内创建发票，支持多币种（法币 + 稳定币）、多链收款，并自动形成收入账本与简单现金流视图。

## 术语表

- **用户 (User)**: 使用 WorkWork Ledger 的自由职业者或小型工作室所有者
- **客户 (Client)**: 用户的客户，即发票的付款方
- **发票 (Invoice)**: 用户创建的收款凭证，包含明细项、金额、支付方式等
- **明细项 (Line Item)**: 发票中的单项服务或商品条目
- **PSP (Payment Service Provider)**: 第三方支付服务提供商，如 Stripe、Airwallex
- **稳定币 (Stablecoin)**: 与法币挂钩的加密货币，如 USDC、USDT
- **链 (Chain)**: 区块链网络，如 Arbitrum、Base、Polygon
- **账本条目 (Ledger Entry)**: 收入记录，每笔已支付发票自动生成的账本条目
- **支付链接 (Payment Link)**: 面向客户的发票支付页面 URL
- **Webhook**: PSP 或链上事件的回调通知机制
- **托管收银台 (Hosted Checkout)**: PSP 提供的托管支付页面

---

## 需求列表

### 需求 1: 用户认证与基础设置

**用户故事:** 作为自由职业者，我希望能够安全地注册并配置基本资料，以便使用我的商业身份开始创建发票。

#### 验收标准

1. 当用户提交有效邮箱地址时，系统应发送 Magic Link 到该邮箱进行无密码认证
2. 当用户在 15 分钟内点击有效的 Magic Link 时，系统应记录设备指纹并创建会话
3. 当用户从已信任设备登录时，系统应直接完成认证并重定向到仪表盘
4. 当用户从新设备登录时，系统应检测设备指纹变化并要求通过邮箱验证码进行额外验证
5. 当用户启用 2FA（双因素认证）时，系统应支持 TOTP 方式（如 Google Authenticator）
6. 当 2FA 已启用且用户登录时，系统应在 Magic Link 验证后要求输入 TOTP 验证码
7. 当用户访问安全设置时，系统应显示已信任设备列表并允许移除设备
8. 当用户访问设置页面时，系统应显示可编辑的商业名称、Logo URL、国家和默认币种字段
9. 当用户保存资料设置时，系统应在 2 秒内持久化更改并显示确认消息
10. 如果 Magic Link 已过期，系统应显示错误消息并提示用户请求新链接

---

### 需求 2: 收款方式配置

**用户故事:** 作为用户，我希望配置收款方式，以便客户可以通过信用卡或稳定币向我付款。

#### 验收标准

1. 当用户访问支付设置时，系统应显示法币支付（PSP）和稳定币支付的配置选项
2. 当用户启用法币支付并提供 PSP API 凭证时，系统应验证凭证并安全存储
3. 当用户启用稳定币支付时，系统应允许选择支持的资产（USDC/USDT）和链（Arbitrum/Base/Polygon）
4. 当用户保存稳定币设置时，系统应为每条启用的链生成或获取收款地址
5. 如果 PSP 凭证验证失败，系统应显示具体的错误消息说明失败原因

---

### 需求 3: 客户管理

**用户故事:** 作为用户，我希望管理客户列表，以便在创建发票时快速选择客户。

#### 验收标准

1. 当用户创建包含名称和邮箱的新客户时，系统应保存客户记录并使其可用于发票选择
2. 当用户查看客户列表时，系统应显示所有客户的名称、邮箱、公司和国家字段
3. 当用户编辑客户记录时，系统应更新存储的信息并在未来发票中反映更改
4. 当用户删除客户时，系统应将客户标记为非活跃状态，同时保留历史发票关联
5. 当用户按名称或邮箱搜索客户时，系统应在 500 毫秒内返回匹配结果

---

### 需求 4: 项目管理（轻量）

**用户故事:** 作为用户，我希望创建项目用于标记发票，以便在报表中按项目追踪收入。

#### 验收标准

1. 当用户创建包含名称的项目时，系统应保存项目并使其可用于发票标记
2. 当用户查看项目列表时，系统应显示所有活跃项目的名称和可选描述
3. 当用户为发票分配项目时，系统应存储关联关系用于报表统计
4. 当用户归档项目时，系统应在新发票选择中隐藏该项目，同时保留历史数据

---

### 需求 5: 发票创建与管理

**用户故事:** 作为用户，我希望创建和管理发票，以便专业地向客户收款并追踪支付状态。

#### 验收标准

1. 当用户创建包含客户、日期、到期日、币种和至少一个明细项的发票时，系统应自动计算小计、税额和总额
2. 当用户添加包含描述、数量和单价的明细项时，系统应计算明细项总额为数量乘以单价
3. 当用户设置税率百分比时，系统应将税率应用于小计并计入总额
4. 当用户保存发票时，系统应分配唯一发票编号并将状态设为"草稿"
5. 当用户发送发票时，系统应生成公开支付链接并将状态更新为"已发送"
6. 当用户导出发票为 PDF 时，系统应在 5 秒内生成包含所有发票详情的可下载 PDF
7. 当用户手动标记发票为已付时，系统应更新状态并创建相应的账本条目
8. 当发票到期日已过且未付款时，系统应自动将状态更新为"逾期"
9. 当用户取消发票时，系统应将状态更新为"已取消"并禁用支付链接
10. 当用户查看发票列表时，系统应显示发票并提供按状态、客户、项目和日期范围的筛选选项

---

### 需求 6: 发票支付页面

**用户故事:** 作为客户，我希望通过简单的支付页面查看和支付发票，以便无需创建账户即可完成付款。

#### 验收标准

1. 当客户访问有效的支付链接时，系统应显示发票详情，包括明细项、金额和可用支付方式
2. 当客户选择卡/本地支付时，系统应重定向到 PSP 托管收银台页面，包含正确的金额和币种
3. 当客户选择稳定币支付时，系统应显示所选链的收款地址和二维码
4. 当客户通过 PSP 完成支付时，系统应接收 webhook、验证支付并将发票状态更新为"已支付"
5. 当客户完成稳定币支付时，系统应检测链上交易、验证金额并将发票状态更新为"已支付"
6. 如果支付链接无效或已过期，系统应显示适当的错误消息
7. 如果支付验证失败，系统应记录错误并保持发票当前状态

---

### 需求 7: 多链统一收款

**用户故事:** 作为用户，我希望在多条链上接收稳定币支付并统一追踪，以便在提供支付灵活性的同时保持简单的记账。

#### 验收标准

1. 当用户启用多链收款时，系统应为每条启用的链管理独立的收款地址
2. 当在任意启用的链上收到稳定币支付时，系统应创建包含链特定详情的账本条目
3. 当显示稳定币收入时，系统应同时展示按资产（USDC/USDT）的统一总额和按链的明细分解
4. 当用户查看支付详情时，系统应显示具体的链、交易哈希和区块确认数

---

### 需求 8: 收入记账与导出

**用户故事:** 作为用户，我希望自动记录收入并具备导出功能，以便追踪收益并为报税做准备。

#### 验收标准

1. 当发票被标记为已付时，系统应自动创建账本条目，包含日期、金额、币种、客户、项目、支付方式、发票 ID 和客户国家
2. 当用户查看账本时，系统应显示条目并提供按时间范围、客户、项目、币种和支付方式的筛选
3. 当用户导出账本数据为 CSV 时，系统应在 10 秒内生成包含所有筛选条目的可下载文件
4. 当显示账本条目时，系统应展示原始币种金额和转换为用户默认币种的金额

---

### 需求 9: 仪表盘

**用户故事:** 作为用户，我希望有一个展示收入概览的仪表盘，以便一目了然地了解我的财务状况。

#### 验收标准

1. 当用户查看仪表盘时，系统应显示所选时间段内转换为默认币种的总收入
2. 当用户选择时间段（本月/本季度/今年/自定义）时，系统应相应更新所有仪表盘指标
3. 当显示收入趋势时，系统应展示按周或月聚合收入的图表
4. 当显示头部客户时，系统应列出收入前 5 名的客户及其贡献百分比
5. 当显示支付方式分布时，系统应展示法币与稳定币收入的比例
6. 当用户配置了预估税率时，系统应显示建议预留税金，计算方式为总收入乘以税率

---

### 需求 10: 数据持久化与序列化

**用户故事:** 作为系统，我需要可靠地存储和检索所有业务数据，以确保用户永不丢失财务记录。

#### 验收标准

1. 当存储发票数据时，系统应将完整的发票对象序列化为 JSON 格式存入数据库
2. 当检索发票数据时，系统应将存储的 JSON 反序列化回原始发票对象结构
3. 当存储账本条目时，系统应序列化条目数据并保持货币金额的完整精度
4. 当检索账本条目时，系统应反序列化并重建包含所有原始字段值的条目
5. 当序列化货币金额时，系统应使用字符串表示以保持小数精度

